name: 构建和发布(dist.zip, app.apk)

on:
  push: 
    branches: ["plugin-mode"]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ENV_STATE: github
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: JDK 23
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '23'
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/android/.gradle/caches
            ~/android/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/android/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Build script run pm
        run: chmod +x ./script/*

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          # cache: 'pnpm'                     

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.17.1                      

      - name: Change depends
        run: sh ./script/install.sh
      
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Prepare tag/name/body variables
        id: vars
        shell: bash
        run: |
          # Determine TAG:
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="release-${GITHUB_RUN_NUMBER}-$(echo ${GITHUB_SHA} | cut -c1-7)"
          fi

          # Name and body
          NAME="Release $TAG"
            # Use the latest commit's subject and link as release body
            COMMIT_SHA="${GITHUB_SHA}"
            SHORT_SHA="${COMMIT_SHA:0:7}"
            COMMIT_SUBJECT="$(git --no-pager log -1 --pretty=format:'%s' "$COMMIT_SHA" 2>/dev/null || echo 'No commit message')"
            BODY="Commit ${SHORT_SHA} — ${COMMIT_SUBJECT} (${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${COMMIT_SHA})"
          # expose outputs
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "body=$BODY" >> "$GITHUB_OUTPUT"

      - name: Install jq (for JSON parsing)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Get or create release (idempotent)
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: $GITHUB_REPOSITORY
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          NAME="${{ steps.vars.outputs.name }}"
          BODY="${{ steps.vars.outputs.body }}"
          repo="$REPO"
          token="$GITHUB_TOKEN"

          echo "Using tag: $TAG"
          # Try to get existing release by tag
          resp=$(curl -s -H "Authorization: token $token" "https://api.github.com/repos/$repo/releases/tags/$TAG")
          # If it has an id field, assume exists
          if echo "$resp" | jq -e '.id' >/dev/null 2>&1; then
            echo "Release for tag $TAG already exists — reusing."
            upload_url=$(echo "$resp" | jq -r '.upload_url' | sed -e "s/{?name,label}//")
            html_url=$(echo "$resp" | jq -r '.html_url')
          else
            echo "Release for tag $TAG not found — creating."
            create_resp=$(curl -s -X POST -H "Authorization: token $token" -H "Content-Type: application/json" \
              -d "$(jq -n --arg t "$TAG" --arg n "$NAME" --arg b "$BODY" '{ tag_name: $t, name: $n, body: $b, draft: false, prerelease: false }')" \
              "https://api.github.com/repos/$repo/releases")
            upload_url=$(echo "$create_resp" | jq -r '.upload_url' | sed -e "s/{?name,label}//")
            html_url=$(echo "$create_resp" | jq -r '.html_url')
          fi

          if [ -z "$upload_url" ] || [ "$upload_url" == "null" ]; then
            echo "Failed to get upload_url. Full response:"
            echo "$resp"
            exit 1
          fi

          echo "upload_url=$upload_url" >> "$GITHUB_OUTPUT"
          echo "html_url=$html_url" >> "$GITHUB_OUTPUT"

      - name: Check for artifacts in ./dist
        id: check_artifacts
        run: |
          has_apk=false
          has_zip=false
          if [ -f ./dist/app.apk ]; then has_apk=true; fi
          if [ -f ./dist/dist.zip ]; then has_zip=true; fi
          echo "has_apk=$has_apk" >> $GITHUB_OUTPUT
          echo "has_zip=$has_zip" >> $GITHUB_OUTPUT
          echo "apk_path=./dist/app.apk" >> $GITHUB_OUTPUT
          echo "zip_path=./dist/dist.zip" >> $GITHUB_OUTPUT

      - name: Upload app.apk to release
        if: steps.check_artifacts.outputs.has_apk == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: ./dist/app.apk
          asset_name: app.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload dist.zip to release
        if: steps.check_artifacts.outputs.has_zip == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: ./dist/dist.zip
          asset_name: dist.zip
          asset_content_type: application/zip